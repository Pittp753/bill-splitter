<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Splitter</title>
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- JS-->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/ocrad.js@0.2.0/ocrad.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/promptparse"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @media (max-width:576px) {
            .table th, .table td {
                font-size: .85rem;
                padding: .3rem
            }
        }

        .custom-ratio {
            max-width: 80px
        }

        .slip-img {
            max-height: 80px;
            object-fit: contain
        }

        .bg-primary {
            background-color: #a3d2ca !important; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡∏°‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
            color: #2f3e46 !important;
        }

        .bg-success {
            background-color: #b5ead7 !important; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•‡∏≠‡πà‡∏≠‡∏ô */
            color: #1b4332 !important;
        }

        .bg-danger {
            background-color: #ffb3b3 !important; /* ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏• */
            color: #7f1d1d !important;
        }

        .badge.bg-success {
            background-color: #b5ead7 !important;
            color: #1b4332 !important;
        }

        .badge.bg-danger {
            background-color: #ffb3b3 !important;
            color: #7f1d1d !important;
        }

        .badge.bg-secondary {
            background-color: #d6d6d6 !important; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
            color: #444 !important;
        }

        .alert-success {
            background-color: #d0f0c0 !important; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•‡∏à‡∏≤‡∏á */
            color: #27632a !important;
        }

        .alert-warning {
            background-color: #fff4cc !important; /* ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•‡∏à‡∏≤‡∏á */
            color: #7a6600 !important;
        }

        .btn-primary {
            background-color: #a3d2ca !important;
            border-color: #a3d2ca !important;
            color: #2f3e46 !important;
        }

            .btn-primary:hover {
                background-color: #8bc4ba !important;
                border-color: #8bc4ba !important;
            }

        .btn-success {
            background-color: #b5ead7 !important;
            border-color: #b5ead7 !important;
            color: #1b4332 !important;
        }

            .btn-success:hover {
                background-color: #9ddfc1 !important;
                border-color: #9ddfc1 !important;
            }

        .btn-danger {
            background-color: #ffb3b3 !important;
            border-color: #ffb3b3 !important;
            color: #7f1d1d !important;
        }

            .btn-danger:hover {
                background-color: #e69a9a !important;
                border-color: #e69a9a !important;
            }
    </style>
</head>

<body>
    <div class="container mt-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">üí∞ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô + ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</h4>
            </div>

            <div class="card-body">

                <!-- ===== Upload Slip ===== -->
                <div class="card mb-3">
                    <div class="card-header">üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
                    <div class="card-body">
                        <input type="file" id="slipFile" class="form-control" accept="image/*" multiple>
                        <div id="slipList" class="mt-3"></div>
                        <button class="btn btn-success w-100 mt-2" onclick="applyAllSlips()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                </div>

                <!-- ===== People Table ===== -->
                <div class="table-responsive">
                    <table class="table table-bordered table-sm" id="peopleTable" style="min-width:750px">
                        <thead class="table-light">
                            <tr>
                                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th>‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</th>
                                <th>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</th>
                                <th>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th>
                                <th width="70"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input class="form-control name" value="A"></td>
                                <td><input type="number" class="form-control paid" value="0"></td>
                                <td>
                                    <select class="form-select ratioSelect">
                                        <option value="1">100%</option>
                                        <option value="0.5">50%</option>
                                        <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                                    </select>
                                    <input type="number" class="form-control custom-ratio d-none mt-1" value="100">
                                </td>
                                <td class="result"></td>
                                <td class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">‡∏•‡∏ö</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="row g-2 mb-3 mt-1 align-items-center">
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô -->
                    <div class="col-6 col-md-auto d-grid">
                        <button class="btn btn-primary w-100" onclick="addRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô</button>
                    </div>

                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì -->
                    <div class="col-6 col-md-auto d-grid">
                        <button class="btn btn-success w-100" onclick="calculate()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
                    </div>

                    <!-- Toggle ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏© -->
                    <div class="col-12 col-md-auto">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="roundToggle" onchange="calculate()">
                            <label class="form-check-label" for="roundToggle">
                                ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </label>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mt-3">
                    <div class="col-md-6">
                        <div class="card border-success h-100">
                            <div class="card-header bg-success text-white">
                                ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô
                            </div>
                            <div class="card-body">
                                <ul class="list-group" id="refundList"></ul>
                                <div class="text-end fw-bold text-success mt-2">
                                    ‡∏£‡∏ß‡∏°: <span id="refundTotal">0</span> ‡∏ö‡∏≤‡∏ó
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6" id="paySection">
                        <div class="card border-danger h-100">
                            <div class="card-header bg-danger text-white">
                                ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </div>
                            <div class="card-body">
                                <ul class="list-group" id="payList"></ul>
                                <div class="text-end fw-bold text-danger mt-2">
                                    ‡∏£‡∏ß‡∏°: <span id="payTotal">0</span> ‡∏ö‡∏≤‡∏ó
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert mt-3" id="balanceAlert"></div>

            </div>
        </div>
    </div>

    <script>
        // ================= People Table =================
        function addRow() {
            const tbody = document.querySelector("#peopleTable tbody")
            const row = tbody.insertRow()
            row.innerHTML = `
                <td><input class="form-control name"></td>
                <td><input type="number" class="form-control paid" value="0"></td>
                <td>
                <select class="form-select ratioSelect">
                <option value="1">100%</option>
                <option value="0.5">50%</option>
                <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                </select>
                <input type="number" class="form-control custom-ratio d-none mt-1" value="100">
                </td>
                <td class="result"></td>
                <td class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">‡∏•‡∏ö</button></td>`
            attachRatio(row)
            refreshSlipPersonSelect()
        }

        function removeRow(btn) {
            btn.closest("tr").remove()
            refreshSlipPersonSelect()
            calculate()
        }

        function attachRatio(row) {
            const select = row.querySelector(".ratioSelect")
            const custom = row.querySelector(".custom-ratio")
            select.addEventListener("change", () => {
                if (select.value === "custom") {
                    custom.classList.remove("d-none")
                } else {
                    custom.classList.add("d-none")
                    custom.value = select.value * 100
                }
                calculate()
            })
        }
        document.querySelectorAll("#peopleTable tbody tr").forEach(attachRatio)

        // ================= Slip Upload =================
        document.getElementById("slipFile").addEventListener("change", async function () {
            const slipList = document.getElementById("slipList")
            slipList.innerHTML = ""
            
            Swal.fire({
                //title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏•‡∏¥‡∏õ...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            const files = Array.from(this.files);

            // ‡πÉ‡∏ä‡πâ Promise.all ‡∏£‡∏≠‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå OCR ‡πÄ‡∏™‡∏£‡πá‡∏à
            await Promise.all(files.map(async (file) => {
                const card = document.createElement("div")
                card.className = "card mb-2"
                card.innerHTML = `
                    <div class="card-body row g-2 align-items-center">
                        <div class="col-md-3"><img src="${URL.createObjectURL(file)}" class="img-fluid slip-img"></div>
                        <div class="col-md-3">
                            <input type="number" class="form-control slip-amount" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select slip-person"></select>
                        </div>
                        <div class="col-md-3"><button class="btn btn-danger btn-sm" onclick="this.closest('.card').remove()">‡∏•‡∏ö</button></div>
                    </div>
                `
                slipList.appendChild(card)
                refreshSlipPersonSelect()

                // ‡∏£‡∏≠ OCR ‡πÄ‡∏™‡∏£‡πá‡∏à
                await preprocessAndRecognize(file, card);
            }));

            // ‡∏õ‡∏¥‡∏î SweetAlert ‡∏´‡∏•‡∏±‡∏á OCR ‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏£‡πá‡∏à
            Swal.close();
        })

        async function preprocessAndRecognize(file, card) {
            return new Promise(resolve => {
                try {
                    EXIF.getData(file, function () {
                        const orientation = EXIF.getTag(this, "Orientation") || 1
                        const img = new Image()
                        img.src = URL.createObjectURL(file)

                        img.onload = async () => {
                            let canvas = document.createElement("canvas")
                            canvas = cropBottom(canvas, 0.1)
                            let ctx = canvas.getContext("2d")

                            let w = img.width
                            let h = img.height

                            // ===== Fix orientation =====
                            if (orientation > 4) {
                                canvas.width = h
                                canvas.height = w
                            } else {
                                canvas.width = w
                                canvas.height = h
                            }

                            switch (orientation) {
                                case 3:
                                    ctx.rotate(Math.PI)
                                    ctx.drawImage(img, -w, -h)
                                    break
                                case 6:
                                    ctx.rotate(Math.PI / 2)
                                    ctx.drawImage(img, 0, -h)
                                    break
                                case 8:
                                    ctx.rotate(-Math.PI / 2)
                                    ctx.drawImage(img, -w, 0)
                                    break
                                default:
                                    ctx.drawImage(img, 0, 0)
                            }

                            // ===== Resize =====
                            const isIphone = /iPhone|iPad|iPod/i.test(navigator.userAgent)
                            const MAX_WIDTH = 1200

                            if (canvas.width > MAX_WIDTH) {
                                const scale = MAX_WIDTH / canvas.width
                                const tmp = document.createElement("canvas")
                                tmp.width = canvas.width * scale
                                tmp.height = canvas.height * scale
                                tmp.getContext("2d").drawImage(canvas, 0, 0, tmp.width, tmp.height)

                                canvas = tmp
                                ctx = canvas.getContext("2d")
                            }

                            // ===== Grayscale + contrast =====
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
                            const data = imageData.data

                            for (let i = 0; i < data.length; i += 4) {
                                const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]
                                const v = Math.min(255, gray * 1.5)
                                data[i] = data[i + 1] = data[i + 2] = v
                            }
                            ctx.putImageData(imageData, 0, 0)

                            // ===== OCR SWITCH =====
                            if (isIphone && window.OCRAD) {
                                useOCRAD(canvas, card)
                                resolve()
                            } else {
                                await useTesseract(canvas, card)
                                resolve()
                            }
                        }
                    })
                } catch (err) {
                    console.error(err)
                    resolve()
                }
            })
        }

        function cropBottom(canvas, ratio) {
            const h = canvas.height
            const w = canvas.width
            const cropY = h * (1 - ratio)

            const cropped = document.createElement("canvas")
            cropped.width = w
            cropped.height = h * ratio

            cropped.getContext("2d").drawImage(
                canvas,
                0, cropY, w, h * ratio,   // source
                0, 0, w, h * ratio        // dest
            )

            return cropped
        }

        function useOCRAD(canvas, card) {
            try {
                const text = OCRAD(canvas)

                const matches = text.match(/\d{1,3}(?:,\d{3})*(?:\.\d{2})?/g)
                if (!matches) return

                const amount = Math.max(
                    ...matches
                        .map(v => parseFloat(v.replace(/,/g, "")))
                        .filter(n => !isNaN(n))
                )

                if (amount && amount > 0) {
                    card.querySelector(".slip-amount").value = amount
                }
            } catch (e) {
                console.error("OCRAD error", e)
            }
        }

        async function useTesseract(canvas, card) {
            return new Promise(resolve => {
                canvas.toBlob(blob => {
                    Tesseract.recognize(blob, 'tha', {
                        psm: 6,
                        tessedit_char_whitelist: '0123456789.,'
                    }).then(({ data: { text } }) => {

                        const matches = text.match(/\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{2})/g)
                        if (matches) {
                            const amount = Math.max(
                                ...matches
                                    .map(v => parseFloat(v.replace(/,/g, '')))
                                    .filter(n => !isNaN(n))
                            )

                            if (amount && amount > 0) {
                                card.querySelector(".slip-amount").value = amount
                            }
                        }
                        resolve()
                    }).catch(err => {
                        console.error(err)
                        resolve()
                    })
                }, 'image/png')
            })
        }

        function refreshSlipPersonSelect() {
            document.querySelectorAll(".slip-person").forEach(select => {
                select.innerHTML = ""
                document.querySelectorAll("#peopleTable tbody tr").forEach((r, i) => {
                    const name = r.querySelector(".name").value || `‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${i + 1}`
                    const opt = document.createElement("option")
                    opt.value = i
                    opt.textContent = name
                    select.appendChild(opt)
                })
            })
        }

        function applyAllSlips() {
            document.querySelectorAll("#slipList .card").forEach(card => {
                const amount = parseFloat(card.querySelector(".slip-amount").value)
                const slipNameInput = card.querySelector(".slip-name")
                const selectPerson = card.querySelector(".slip-person")

                if (isNaN(amount)) return

                let index = null

                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠ ‚Üí ‡∏´‡∏≤/‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ô
                if (slipNameInput && slipNameInput.value.trim()) {
                    index = findOrCreatePersonIndex(slipNameInput.value)
                } 
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠ ‚Üí ‡πÉ‡∏ä‡πâ dropdown
                else {
                    index = selectPerson.value
                }

                if (index === null) return

                const paid = document.querySelectorAll(".paid")[index]
                paid.value = (parseFloat(paid.value) || 0) + amount
            })

            document.getElementById("slipList").innerHTML = ""
            document.getElementById("slipFile").value = ""
            refreshSlipPersonSelect()
            calculate()
        }

        function findOrCreatePersonIndex(name) {
            const rows = document.querySelectorAll("#peopleTable tbody tr")
            name = name.trim()
            if (!name) return null

            // ‡∏´‡∏≤ name ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
            for (let i = 0; i < rows.length; i++) {
                const inputName = rows[i].querySelector(".name").value.trim()
                if (inputName === name) return i
            }

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
            addRow()
            const newRows = document.querySelectorAll("#peopleTable tbody tr")
            const index = newRows.length - 1
            newRows[index].querySelector(".name").value = name
            return index
        }

        // ================= Calculate =================
        function calculate() {
            let rows = document.querySelectorAll("#peopleTable tbody tr")
            let totalPaid = 0, totalRatio = 0, roundExtra = 0

            rows.forEach(r => {
                totalPaid += parseFloat(r.querySelector(".paid").value) || 0
                totalRatio += (parseFloat(r.querySelector(".custom-ratio").value) || 100) / 100
            })

            const perUnit = totalRatio ? totalPaid / totalRatio : 0

            const refundList = document.getElementById("refundList")
            const payList = document.getElementById("payList")
            refundList.innerHTML = ""
            payList.innerHTML = ""

            let refundTotal = 0
            let payTotal = 0
            let balance = 0

            rows.forEach(r => {
                const name = r.querySelector(".name").value || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠"
                const paid = parseFloat(r.querySelector(".paid").value) || 0
                const ratio = (parseFloat(r.querySelector(".custom-ratio").value) || 100) / 100
                const diff = paid - (perUnit * ratio)
                const cell = r.querySelector(".result")

                if (diff > 0) {
                    cell.innerHTML = `<span class="badge bg-success">‡∏£‡∏±‡∏ö ${diff.toFixed(2)}</span>`
                    refundTotal += diff
                    refundList.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between">
                        ${name}
                        <span class="text-success">${diff.toFixed(2)}</span>
                    </li>`
                }
                else if (diff < 0) {
                    let pay = Math.abs(diff)
                    let roundedPay = pay
                    let roundDiff = 0

                    if (document.getElementById("roundToggle").checked) {
                        roundedPay = Math.ceil(pay)
                        roundDiff = roundedPay - pay
                        roundExtra += roundDiff
                    }

                    cell.innerHTML = `
                        <span class="badge bg-danger">‡∏à‡πà‡∏≤‡∏¢ ${pay.toFixed(2)}</span>
                    `

                    payTotal += roundedPay

                    payList.innerHTML += `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <span>${name}</span>
                            <span class="text-danger">${roundedPay.toFixed(2)}</span>
                        </div>
                        ${roundDiff > 0
                            //? `<div class="small text-muted text-end">
                            //    (‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏© +${roundDiff.toFixed(2)})
                            //   </div>`
                            //: ""}
                            ? `<div class="small text-muted text-end">
                               </div>`
                            : ""}
                    </li>`
                }
                else {
                    cell.innerHTML = `<span class="badge bg-secondary">‡∏û‡∏≠‡∏î‡∏µ</span>`
                }

                balance += diff
            })

            document.getElementById("refundTotal").innerText = refundTotal.toFixed(2)
            document.getElementById("payTotal").innerText = payTotal.toFixed(2)

            const alert = document.getElementById("balanceAlert")

            if (roundExtra > 0) {
                alert.className = "mt-3 alert alert-warning"
                alert.innerText = `‚ö†Ô∏è ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏°‡∏î‡∏∏‡∏• ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏© ${roundExtra.toFixed(2)} ‡∏ö‡∏≤‡∏ó`
            } else {
                alert.className = "mt-3 alert alert-success"
                alert.innerText = "‚úÖ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•"
            }
        }

        calculate()
    </script>
</body>
</html>